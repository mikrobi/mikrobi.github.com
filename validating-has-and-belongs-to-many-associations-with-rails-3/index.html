
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Validating has_and_belongs_to_many Associations with Rails 3 - Jakob Class</title>
  <meta name="author" content="Jakob Class">

  
  <meta name="description" content="This week I had to deal with validating a has_and_belongs_to_many association. Unfortunately I had to realize that ActiveRecord is not able to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mikrobi.github.com/validating-has-and-belongs-to-many-associations-with-rails-3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jakob Class" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37687984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Jakob Class</a></h1>
  
    <h2>Passionate software developer fascinated by entrepreneurship.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mikrobi.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Validating has_and_belongs_to_many Associations with Rails 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-03T10:38:00+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This week I had to deal with validating a <code>has_and_belongs_to_many</code> association. Unfortunately I had to realize that ActiveRecord is not able to properly validate these kind of associations. Even when validation fails, associations are stored in the database. However ActiveRecord can be adjusted with the <a href="https://github.com/MartinKoerner/deferred_associations">deferred_associations gem</a> to prevent invalid associations being persisted.</p>

<!-- more -->


<p>In case of two models that have a n:m relationship, e.g groups and users, you can create a join table for storing associations between groups and users and use the <a href="http://apidock.com/rails/ActiveRecord/Associations/ClassMethods/has_and_belongs_to_many">has_and_belongs_to_many macro</a> to make ActiveRecord manage this join table.</p>

<p>In the following example a custom validation is defined to ensure a group does not consist of more than 10 users.</p>

<figure class='code'><figcaption><span>app/models/group.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Group</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_and_belongs_to_many</span> <span class="ss">:users</span>
</span><span class='line'>  <span class="n">validate</span> <span class="ss">:has_ten_or_less_users</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">has_ten_or_less_users</span>
</span><span class='line'>    <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="s1">&#39;not more than 10 users allowed&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At first glance the validation seems to do the job and the following spec is passing:</p>

<figure class='code'><figcaption><span>spec/models/group_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Group</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#users&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">context</span> <span class="s1">&#39;when assigning to one user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">users</span> <span class="o">&lt;&lt;</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s1">&#39;when assigning to more than 10 users&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>        <span class="mi">11</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">users</span> <span class="o">&lt;&lt;</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But after assigning 11 users to a group there will be 11 entries persisted in the join table, although the validation fails. This is because ActiveRecords inserts the references into the join table right after assignment before any validations are tested. The following spec is not passing any more:</p>

<figure class='code'><figcaption><span>spec/models/group_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Group</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#users&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">context</span> <span class="s1">&#39;when assigning to one user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">users</span> <span class="o">&lt;&lt;</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s1">&#39;when assigning to more than 10 users&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">subject</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>        <span class="mi">11</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">users</span> <span class="o">&lt;&lt;</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">specify</span> <span class="s1">&#39;associations should not be stored&#39;</span> <span class="k">do</span>
</span><span class='line'>        <span class="c1"># reload group from DB to make sure that</span>
</span><span class='line'>        <span class="c1"># invalid associations have not been stored</span>
</span><span class='line'>        <span class="n">subject</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">users</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<pre>
Failures:

  1) Group#users when assigning to more than 10 users associations should not be stored
     Failure/Error: expect(subject.users).not_to have(11).users
       expected target not to have 11 users, got 11
     # ./spec/models/group_spec.rb:21:in `block (4 levels) in <top (required)>'
</pre>


<p>After investigating this issue I found a <a href="http://mattberther.com/2012/09/09/validating-habtm-relationships-with-rails-3x">proposal for a solution</a> and a <a href="https://github.com/TylerRick/has_and_belongs_to_many_with_deferred_save">gem</a> that try to fix it. Neither of them worked in our Rails 3.2 environment. The last commit to the gem was 3 years ago and Rails 3 seems not to be supported. However <a href="https://github.com/MartinKoerner">MartinKoerner</a> extended the legacy gem and provides a gem that does the job for Rails 3: <a href="https://github.com/MartinKoerner/deferred_associations">deferred_associations</a>.</p>

<p>Simply add <code>gem 'deferred_associations'</code> into your Gemfile and change <code>has_and_belongs_to_many</code> to <code>has_and_belongs_to_many_with_deferred_save</code> in your model class:</p>

<figure class='code'><figcaption><span>app/models/group.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Group</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_and_belongs_to_many_with_deferred_save</span> <span class="ss">:users</span>
</span><span class='line'>  <span class="n">validate</span> <span class="ss">:has_ten_or_less_users</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">has_ten_or_less_users</span>
</span><span class='line'>    <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="s1">&#39;not more than 10 users allowed&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Et voil√†, all examples are passing:</p>

<pre>
Group
  #users
    when assigning to one user
      should be valid
    when assigning to more than 10 users
      should not be valid
      associations should not be stored

Finished in 0.15135 seconds
3 examples, 0 failures
</pre>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jakob Class</span></span>

      








  


<time datetime="2013-02-03T10:38:00+01:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mikrobi.github.com/validating-has-and-belongs-to-many-associations-with-rails-3/" data-via="" data-counturl="http://mikrobi.github.com/validating-has-and-belongs-to-many-associations-with-rails-3/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/merging-i18n-translations-for-simpleform-and-formtastic/" title="Previous Post: Merging I18n Translations for SimpleForm and Formtastic">&laquo; Merging I18n Translations for SimpleForm and Formtastic</a>
      
      
        <a class="basic-alignment right" href="/how-to-recover-your-local-octopress-repository/" title="Next Post: How to recover your local Octopress repository">How to recover your local Octopress repository &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/how-to-recover-your-local-octopress-repository/">How to recover your local Octopress repository</a>
      </li>
    
      <li class="post">
        <a href="/validating-has-and-belongs-to-many-associations-with-rails-3/">Validating has_and_belongs_to_many Associations with Rails 3</a>
      </li>
    
      <li class="post">
        <a href="/merging-i18n-translations-for-simpleform-and-formtastic/">Merging I18n Translations for SimpleForm and Formtastic</a>
      </li>
    
      <li class="post">
        <a href="/creating-a-free-blog-in-10-minutes-with-github-pages-and-octopress/">Creating a Free Blog in 10 Minutes with GitHub Pages and Octopress</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mikrobi">@mikrobi</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mikrobi',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jakob Class -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mikrobi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mikrobi.github.com/validating-has-and-belongs-to-many-associations-with-rails-3/';
        var disqus_url = 'http://mikrobi.github.com/validating-has-and-belongs-to-many-associations-with-rails-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
